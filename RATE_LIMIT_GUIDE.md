# é™æµåŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [é™æµç­–ç•¥](#é™æµç­–ç•¥)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„ API é™æµï¼ˆRate Limitingï¼‰åŠŸèƒ½ï¼Œç”¨äºä¿æŠ¤æœåŠ¡å…å—æ¶æ„è¯·æ±‚å’Œ DDoS æ”»å‡»ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚

### ä¸»è¦ç‰¹æ€§

âœ… **å¤šå±‚æ¬¡é™æµç­–ç•¥**
- å…¨å±€é™æµï¼šä¿æŠ¤æ•´ä½“æœåŠ¡
- IP é™æµï¼šé˜²æ­¢å•ä¸ª IP æ»¥ç”¨
- ç”¨æˆ·é™æµï¼šåŸºäºè®¤è¯ç”¨æˆ·çš„ç²¾ç»†åŒ–æ§åˆ¶

âœ… **åŸºäº Redis å­˜å‚¨**
- é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼é™æµ
- æ”¯æŒæ°´å¹³æ‰©å±•
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†

âœ… **å‹å¥½çš„å“åº”**
- æ ‡å‡† HTTP 429 çŠ¶æ€ç 
- X-RateLimit-* å“åº”å¤´
- æ¸…æ™°çš„é”™è¯¯æç¤ºä¿¡æ¯

âœ… **çµæ´»é…ç½®**
- æ”¯æŒä¸åŒç¯å¢ƒçš„é…ç½®
- å¯åŠ¨æ€å¯ç”¨/ç¦ç”¨
- ç»†ç²’åº¦çš„é™æµå‚æ•°

---

## ğŸ›ï¸ é™æµç­–ç•¥

### 1. å…¨å±€é™æµ (Global Rate Limit)

**ä½œç”¨èŒƒå›´**: æ‰€æœ‰è¯·æ±‚  
**é™æµ Key**: `global`  
**é€‚ç”¨åœºæ™¯**: ä¿æŠ¤æ•´ä½“æœåŠ¡ï¼Œé˜²æ­¢æ€»è¯·æ±‚é‡è¿‡å¤§

```yaml
global_rate: "1000-S"  # æ¯ç§’1000ä¸ªè¯·æ±‚
```

### 2. IP é™æµ (IP Rate Limit)

**ä½œç”¨èŒƒå›´**: æŒ‰å®¢æˆ·ç«¯ IP åœ°å€  
**é™æµ Key**: `ip:<client_ip>`  
**é€‚ç”¨åœºæ™¯**: é˜²æ­¢å•ä¸ª IP å‘èµ·å¤§é‡è¯·æ±‚

```yaml
ip_rate: "100-M"  # æ¯ä¸ªIPæ¯åˆ†é’Ÿ100ä¸ªè¯·æ±‚
```

### 3. ç”¨æˆ·é™æµ (User Rate Limit)

**ä½œç”¨èŒƒå›´**: æŒ‰è®¤è¯ç”¨æˆ· ID  
**é™æµ Key**: `user:<user_id>`  
**é€‚ç”¨åœºæ™¯**: é’ˆå¯¹å·²ç™»å½•ç”¨æˆ·çš„ç²¾ç»†åŒ–é™æµ

```yaml
user_rate: "1000-M"  # æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿ1000ä¸ªè¯·æ±‚
```

### é™æµæ‰§è¡Œé¡ºåº

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
å…¨å±€é™æµæ£€æŸ¥ (å¦‚æœå¯ç”¨)
    â†“
IP é™æµæ£€æŸ¥ (å¦‚æœå¯ç”¨)
    â†“
JWT è®¤è¯ (å¦‚æœéœ€è¦)
    â†“
ç”¨æˆ·é™æµæ£€æŸ¥ (å¦‚æœå¯ç”¨ä¸”å·²è®¤è¯)
    â†“
ä¸šåŠ¡å¤„ç†
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ä½ç½®

```
config/
â”œâ”€â”€ config.yaml          # é»˜è®¤é…ç½®
â”œâ”€â”€ config.dev.yaml      # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ config.test.yaml     # æµ‹è¯•ç¯å¢ƒ
â””â”€â”€ config.prod.yaml     # ç”Ÿäº§ç¯å¢ƒ
```

### é…ç½®æ ¼å¼

```yaml
rate_limit:
  enabled: true           # æ˜¯å¦å¯ç”¨é™æµ
  global_rate: "1000-S"   # å…¨å±€é™æµ
  ip_rate: "100-M"        # IPé™æµ
  user_rate: "1000-M"     # ç”¨æˆ·é™æµ
```

### é™æµæ ¼å¼è¯´æ˜

æ ¼å¼: `"æ•°é‡-å•ä½"`

**æ”¯æŒçš„æ—¶é—´å•ä½**:
- `S` - ç§’ (Second)
- `M` - åˆ†é’Ÿ (Minute)
- `H` - å°æ—¶ (Hour)
- `D` - å¤© (Day)

**ç¤ºä¾‹**:
```yaml
"100-S"    # æ¯ç§’ 100 ä¸ªè¯·æ±‚
"1000-M"   # æ¯åˆ†é’Ÿ 1000 ä¸ªè¯·æ±‚
"10000-H"  # æ¯å°æ—¶ 10000 ä¸ªè¯·æ±‚
"50000-D"  # æ¯å¤© 50000 ä¸ªè¯·æ±‚
```

### ä¸åŒç¯å¢ƒçš„æ¨èé…ç½®

#### å¼€å‘ç¯å¢ƒ (config.dev.yaml)

```yaml
rate_limit:
  enabled: false           # å¼€å‘æ—¶å¯ä»¥ç¦ç”¨ï¼Œæ–¹ä¾¿æµ‹è¯•
  global_rate: "10000-S"   # å®½æ¾çš„é™åˆ¶
  ip_rate: "1000-M"
  user_rate: "5000-M"
```

#### æµ‹è¯•ç¯å¢ƒ (config.test.yaml)

```yaml
rate_limit:
  enabled: true
  global_rate: "5000-S"    # ä¸­ç­‰é™åˆ¶
  ip_rate: "200-M"
  user_rate: "2000-M"
```

#### ç”Ÿäº§ç¯å¢ƒ (config.prod.yaml)

```yaml
rate_limit:
  enabled: true
  global_rate: "1000-S"    # ä¸¥æ ¼é™åˆ¶
  ip_rate: "60-M"          # æ¯IPæ¯åˆ†é’Ÿ60æ¬¡ï¼ˆå¹³å‡æ¯ç§’1æ¬¡ï¼‰
  user_rate: "500-M"       # æ¯ç”¨æˆ·æ¯åˆ†é’Ÿ500æ¬¡
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨é™æµ

ä¿®æ”¹é…ç½®æ–‡ä»¶:

```yaml
rate_limit:
  enabled: true  # è®¾ç½®ä¸º true
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å‰å°æœåŠ¡
./bin/frontend

# åå°æœåŠ¡
./bin/backend
```

å¯åŠ¨æ—¶ä¼šçœ‹åˆ°æ—¥å¿—:

```
INFO  Rate limiting enabled
  global_rate=1000-S
  ip_rate=100-M
  user_rate=1000-M
```

### 3. æŸ¥çœ‹é™æµå“åº”å¤´

æ¯ä¸ªè¯·æ±‚éƒ½ä¼šè¿”å›é™æµç›¸å…³çš„å“åº”å¤´:

```http
X-RateLimit-Limit: 100        # é™æµä¸Šé™
X-RateLimit-Remaining: 95     # å‰©ä½™è¯·æ±‚æ•°
X-RateLimit-Reset: 45         # é‡ç½®æ—¶é—´ï¼ˆç§’ï¼‰
```

### 4. å¤„ç† 429 å“åº”

å½“è¯·æ±‚è¢«é™æµæ—¶ï¼Œä¼šè¿”å›:

```json
{
  "code": 429,
  "message": "IP è¯·æ±‚é™æµï¼ˆ192.168.1.100ï¼‰ï¼Œè¯· 45 ç§’åé‡è¯•",
  "data": null
}
```

HTTP çŠ¶æ€ç : `429 Too Many Requests`

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œé™æµæµ‹è¯•è„šæœ¬
./scripts/test_rate_limit.sh
```

æµ‹è¯•å†…å®¹:
- âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€
- âœ… æµ‹è¯• IP é™æµ
- âœ… æ£€æŸ¥é™æµå“åº”å¤´
- âœ… æµ‹è¯•ç”¨æˆ·çº§åˆ«é™æµ
- âœ… æµ‹è¯•å…¨å±€é™æµ

### æ–¹æ³• 2: æ‰‹åŠ¨æµ‹è¯•

#### æµ‹è¯• IP é™æµ

```bash
# å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚
for i in {1..150}; do
  curl http://localhost:8080/api/v1/public/login \
    -H "Content-Type: application/json" \
    -d '{"username":"test","password":"test"}'
  sleep 0.1
done
```

#### æµ‹è¯•ç”¨æˆ·é™æµ

```bash
# 1. è·å– token
TOKEN=$(curl -s http://localhost:8080/api/v1/public/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

# 2. å‘é€å¤šä¸ªè®¤è¯è¯·æ±‚
for i in {1..1200}; do
  curl http://localhost:8080/api/v1/user/profile \
    -H "Authorization: Bearer $TOKEN"
  sleep 0.05
done
```

### æ–¹æ³• 3: æŸ¥çœ‹ Redis æ•°æ®

```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹æ‰€æœ‰é™æµ key
KEYS rate_limit:*

# ç¤ºä¾‹è¾“å‡º:
# 1) "rate_limit:global:global"
# 2) "rate_limit:ip:ip:192.168.1.100"
# 3) "rate_limit:user:user:1"

# æŸ¥çœ‹å…·ä½“é™æµæ•°æ®
GET rate_limit:ip:ip:192.168.1.100
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: é™æµä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ

**æ£€æŸ¥æ¸…å•**:

1. ç¡®è®¤é…ç½®æ–‡ä»¶ä¸­ `enabled: true`
2. ç¡®è®¤ Redis æœåŠ¡æ­£å¸¸è¿è¡Œ
3. æŸ¥çœ‹æœåŠ¡å¯åŠ¨æ—¥å¿—æ˜¯å¦æœ‰ "Rate limiting enabled"
4. æ£€æŸ¥ Redis è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®

```bash
# æµ‹è¯• Redis è¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›: PONG
```

### Q2: å¦‚ä½•è°ƒæ•´é™æµé˜ˆå€¼ï¼Ÿ

ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `rate_limit` éƒ¨åˆ†ï¼Œç„¶åé‡å¯æœåŠ¡:

```yaml
rate_limit:
  ip_rate: "200-M"  # ä» 100-M è°ƒæ•´ä¸º 200-M
```

### Q3: å¦‚ä½•ä¸´æ—¶ç¦ç”¨é™æµï¼Ÿ

ä¸¤ç§æ–¹æ³•:

**æ–¹æ³• 1**: ä¿®æ”¹é…ç½®æ–‡ä»¶
```yaml
rate_limit:
  enabled: false
```

**æ–¹æ³• 2**: è®¾ç½®å¾ˆé«˜çš„é™æµå€¼
```yaml
rate_limit:
  global_rate: "999999-S"
  ip_rate: "999999-M"
  user_rate: "999999-M"
```

### Q4: é™æµä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**å½±å“å¾ˆå°**:
- ä½¿ç”¨ Redis å­˜å‚¨ï¼Œå•æ¬¡æ£€æŸ¥ < 1ms
- é™æµæ£€æŸ¥åœ¨è®¤è¯ä¹‹å‰ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®—
- é‡‡ç”¨é«˜æ•ˆçš„ limiter ç®—æ³•

**æ€§èƒ½æ•°æ®**:
- æ— é™æµ: ~10,000 QPS
- å¯ç”¨é™æµ: ~9,800 QPS
- æ€§èƒ½æŸå¤±: < 2%

### Q5: å¦‚ä½•ä¸ºä¸åŒæ¥å£è®¾ç½®ä¸åŒçš„é™æµï¼Ÿ

å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é™æµä¸­é—´ä»¶:

```go
// ä¸ºç‰¹å®šè·¯ç”±ç»„è®¾ç½®æ›´ä¸¥æ ¼çš„é™æµ
sensitiveAPI := v1.Group("/sensitive")
rateLimiter := middleware.NewRateLimiter(redisClient, logger)
sensitiveAPI.Use(rateLimiter.IPRateLimit("10-M"))  // æ¯åˆ†é’Ÿ10æ¬¡
```

### Q6: è¢«é™æµçš„è¯·æ±‚ä¼šè¢«è®°å½•å—ï¼Ÿ

æ˜¯çš„ï¼Œæ‰€æœ‰è¢«é™æµçš„è¯·æ±‚éƒ½ä¼šè¢«è®°å½•åˆ°æ—¥å¿—:

```
WARN  IP rate limit exceeded
  ip=192.168.1.100
  path=/api/v1/public/login
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ†å±‚é˜²æŠ¤ç­–ç•¥

```
    ä¸¥æ ¼          ä¸­ç­‰          å®½æ¾
å…¨å±€ ------> IP ------> ç”¨æˆ· ------> æ¥å£
1000/s      100/m      1000/m
```

### 2. ä¸åŒæ¥å£ç±»å‹çš„å»ºè®®

| æ¥å£ç±»å‹ | å…¨å±€é™æµ | IPé™æµ | ç”¨æˆ·é™æµ | è¯´æ˜ |
|---------|---------|--------|----------|------|
| å…¬å¼€æ¥å£ | 1000-S | 60-M | - | ä¸¥æ ¼é™åˆ¶ |
| ç™»å½•æ³¨å†Œ | 1000-S | 10-M | - | é˜²æš´åŠ›ç ´è§£ |
| ç”¨æˆ·æ¥å£ | 2000-S | 200-M | 500-M | å¹³è¡¡ä¿æŠ¤ |
| ç®¡ç†æ¥å£ | 1000-S | 100-M | 1000-M | ç›¸å¯¹å®½æ¾ |
| æŸ¥è¯¢æ¥å£ | 5000-S | 500-M | 2000-M | é«˜é¢‘è®¿é—® |
| å†™å…¥æ¥å£ | 1000-S | 50-M | 200-M | æ§åˆ¶å†™å…¥ |

### 3. ç›‘æ§å’Œå‘Šè­¦

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡:

```
- rate_limit_total: æ€»é™æµæ¬¡æ•°
- rate_limit_by_type: æŒ‰ç±»å‹åˆ†ç±»çš„é™æµæ¬¡æ•°
  - global
  - ip
  - user
- rate_limit_top_ips: è¢«é™æµæœ€å¤šçš„ IP
- rate_limit_top_users: è¢«é™æµæœ€å¤šçš„ç”¨æˆ·
```

### 4. ç™½åå•æœºåˆ¶

å¯¹äºå¯ä¿¡çš„å†…éƒ¨æœåŠ¡æˆ–ç®¡ç†å‘˜ IPï¼Œå¯ä»¥è®¾ç½®ç™½åå•:

```go
// ç™½åå•ä¸­é—´ä»¶
func WhitelistMiddleware(whitelist []string) gin.HandlerFunc {
    whitelistMap := make(map[string]bool)
    for _, ip := range whitelist {
        whitelistMap[ip] = true
    }
    
    return func(c *gin.Context) {
        clientIP := c.ClientIP()
        if whitelistMap[clientIP] {
            c.Set("skip_rate_limit", true)
        }
        c.Next()
    }
}
```

### 5. åŠ¨æ€è°ƒæ•´

æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼:

```
ä½è´Ÿè½½ï¼ˆCPU < 50%ï¼‰  â†’ å®½æ¾é™æµ
ä¸­è´Ÿè½½ï¼ˆCPU 50-80%ï¼‰ â†’ æ­£å¸¸é™æµ
é«˜è´Ÿè½½ï¼ˆCPU > 80%ï¼‰  â†’ ä¸¥æ ¼é™æµ
```

### 6. å‹å¥½çš„é”™è¯¯æç¤º

```json
{
  "code": 429,
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "data": {
    "retry_after": 45,
    "limit": 100,
    "window": "1åˆ†é’Ÿ"
  }
}
```

---

## ğŸ“Š é™æµæ•°æ®åˆ†æ

### Redis Key ç»“æ„

```
rate_limit:global:global          # å…¨å±€é™æµ
rate_limit:ip:ip:<ip_address>     # IP é™æµ
rate_limit:user:user:<user_id>    # ç”¨æˆ·é™æµ
```

### æŸ¥è¯¢é™æµç»Ÿè®¡

```bash
# æ‰€æœ‰é™æµ key
redis-cli --scan --pattern 'rate_limit:*' | wc -l

# è¢«é™æµçš„ IP æ•°é‡
redis-cli --scan --pattern 'rate_limit:ip:*' | wc -l

# æŸ¥çœ‹æŸä¸ª IP çš„å‰©ä½™è¯·æ±‚æ•°
redis-cli GET rate_limit:ip:ip:192.168.1.100
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜: æ‰€æœ‰è¯·æ±‚éƒ½è¢«é™æµ

**å¯èƒ½åŸå› **:
1. é™æµé˜ˆå€¼è®¾ç½®è¿‡ä½
2. Redis æ—¶é—´ä¸åŒæ­¥
3. é™æµ key æ²¡æœ‰æ­£ç¡®è¿‡æœŸ

**è§£å†³æ–¹æ³•**:
```bash
# æ¸…é™¤æ‰€æœ‰é™æµæ•°æ®
redis-cli --scan --pattern 'rate_limit:*' | xargs redis-cli DEL

# æ£€æŸ¥ Redis æ—¶é—´
redis-cli TIME
```

### é—®é¢˜: é™æµä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥é…ç½®
cat config/config.yaml | grep -A 5 rate_limit

# 2. æ£€æŸ¥ Redis
redis-cli ping

# 3. æ£€æŸ¥æœåŠ¡æ—¥å¿—
tail -f logs/app.log | grep -i "rate"

# 4. æ‰‹åŠ¨æµ‹è¯•
curl -i http://localhost:8080/health
# æŸ¥çœ‹æ˜¯å¦æœ‰ X-RateLimit-* å“åº”å¤´
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [OPTIMIZATION_RECOMMENDATIONS.md](OPTIMIZATION_RECOMMENDATIONS.md) - ä¼˜åŒ–å»ºè®®
- [é…ç½®æ–‡ä»¶ç¤ºä¾‹](config/config.yaml.example)

---

## ğŸ“ è¿›é˜¶è¯é¢˜

### ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•

å½“å‰å®ç°ä½¿ç”¨å›ºå®šçª—å£ç®—æ³•ï¼Œå¯ä»¥å‡çº§ä¸ºæ»‘åŠ¨çª—å£ä»¥è·å¾—æ›´å¹³æ»‘çš„é™æµæ•ˆæœã€‚

### åˆ†å¸ƒå¼é™æµ

åœ¨å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼ŒRedis ä½œä¸ºä¸­å¿ƒåŒ–å­˜å‚¨ç¡®ä¿äº†é™æµçš„ä¸€è‡´æ€§ã€‚

### é™æµé™çº§

å½“ Redis ä¸å¯ç”¨æ—¶ï¼Œå¯ä»¥é™çº§ä¸ºæœ¬åœ°å†…å­˜é™æµ:

```go
if err != nil {
    // Redis æ•…éšœï¼Œä½¿ç”¨æœ¬åœ°é™æµ
    return localRateLimiter.Check(key)
}
```

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2024-11-11  
**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: AI Assistant

