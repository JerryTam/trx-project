package main

import (
	"encoding/json"
	"fmt"
	"os"
	"path/filepath"
	"strings"
)

func main() {
	if len(os.Args) < 4 {
		fmt.Println("Usage: go run filter_swagger_docs.go <docs-dir> <instance-name> <exclude-prefix1> [exclude-prefix2...]")
		fmt.Println("Example: go run filter_swagger_docs.go cmd/frontend/docs frontend admin users")
		os.Exit(1)
	}

	docsDir := os.Args[1]
	instanceName := os.Args[2]
	excludePrefixes := []string{}

	// å¤„ç†å¤šä¸ªæ’é™¤å‰ç¼€
	for i := 3; i < len(os.Args); i++ {
		prefix := os.Args[i]
		// ç¡®ä¿å‰ç¼€ä»¥ / å¼€å¤´
		if !strings.HasPrefix(prefix, "/") {
			prefix = "/" + prefix
		}
		excludePrefixes = append(excludePrefixes, prefix)
	}

	// JSON æ–‡ä»¶è·¯å¾„
	jsonFile := filepath.Join(docsDir, instanceName+"_swagger.json")
	goFile := filepath.Join(docsDir, instanceName+"_docs.go")

	// è¿‡æ»¤ JSON æ–‡ä»¶
	if err := filterJSON(jsonFile, excludePrefixes); err != nil {
		fmt.Printf("Error filtering JSON: %v\n", err)
		os.Exit(1)
	}

	// è¿‡æ»¤ Go æ–‡ä»¶
	if err := filterGoFile(goFile, jsonFile, instanceName); err != nil {
		fmt.Printf("Error filtering Go file: %v\n", err)
		os.Exit(1)
	}

	fmt.Printf("âœ… Filtered both JSON and Go files successfully\n")
}

func filterJSON(jsonFile string, excludePrefixes []string) error {
	// è¯»å– JSON æ–‡ä»¶
	data, err := os.ReadFile(jsonFile)
	if err != nil {
		return fmt.Errorf("reading JSON file: %w", err)
	}

	// è§£æ JSON
	var swagger map[string]interface{}
	if err := json.Unmarshal(data, &swagger); err != nil {
		return fmt.Errorf("parsing JSON: %w", err)
	}

	// è¿‡æ»¤ paths
	filteredCount := 0
	if paths, ok := swagger["paths"].(map[string]interface{}); ok {
		for path := range paths {
			shouldDelete := false
			for _, prefix := range excludePrefixes {
				if strings.HasPrefix(path, prefix) {
					shouldDelete = true
					break
				}
			}
			if shouldDelete {
				delete(paths, path)
				filteredCount++
			}
		}
	}

	fmt.Printf("ğŸ“Š Filtered %d paths from JSON with prefixes %v\n", filteredCount, excludePrefixes)

	// å†™å…¥æ–°æ–‡ä»¶
	output, err := json.MarshalIndent(swagger, "", "    ")
	if err != nil {
		return fmt.Errorf("marshaling JSON: %w", err)
	}

	if err := os.WriteFile(jsonFile, output, 0644); err != nil {
		return fmt.Errorf("writing JSON file: %w", err)
	}

	return nil
}

func filterGoFile(goFile, jsonFile, instanceName string) error {
	// è¯»å–è¿‡æ»¤åçš„ JSON
	jsonData, err := os.ReadFile(jsonFile)
	if err != nil {
		return fmt.Errorf("reading filtered JSON: %w", err)
	}

	// è¯»å–åŸ Go æ–‡ä»¶
	goData, err := os.ReadFile(goFile)
	if err != nil {
		return fmt.Errorf("reading Go file: %w", err)
	}

	goContent := string(goData)
	jsonStr := string(jsonData)

	// æ‰¾åˆ° docTemplate çš„å¼€å§‹å’Œç»“æŸä½ç½®
	// æ ¼å¼: const docTemplate{instanceName} = `...`
	templateStart := "const docTemplate" + instanceName + " = `"
	startIdx := strings.Index(goContent, templateStart)
	if startIdx == -1 {
		return fmt.Errorf("could not find docTemplate%s in Go file", instanceName)
	}

	// æ‰¾åˆ°æ¨¡æ¿å†…å®¹çš„å¼€å§‹ä½ç½®ï¼ˆç¬¬ä¸€ä¸ª ` ä¹‹åï¼‰
	contentStart := startIdx + len(templateStart)
	
	// æ‰¾åˆ°ç»“æŸçš„ ` ä½ç½®
	endIdx := strings.Index(goContent[contentStart:], "`")
	if endIdx == -1 {
		return fmt.Errorf("could not find end of docTemplate%s", instanceName)
	}
	contentEnd := contentStart + endIdx

	// æ„å»ºæ–°çš„ Go æ–‡ä»¶å†…å®¹
	newGoContent := goContent[:contentStart] + jsonStr + goContent[contentEnd:]

	// å†™å…¥æ–°çš„ Go æ–‡ä»¶
	if err := os.WriteFile(goFile, []byte(newGoContent), 0644); err != nil {
		return fmt.Errorf("writing Go file: %w", err)
	}

	fmt.Printf("ğŸ“Š Updated Go file: %s\n", goFile)
	return nil
}

